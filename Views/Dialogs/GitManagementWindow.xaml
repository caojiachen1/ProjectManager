<ui:FluentWindow
    x:Class="ProjectManager.Views.Dialogs.GitManagementWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    Title="{DynamicResource Git_Title}"
    Width="800"
    Height="700"
    WindowStartupLocation="CenterOwner"
    ResizeMode="CanResize"
    ExtendsContentIntoTitleBar="True">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <ui:TitleBar
            x:Name="TitleBar"
            Title="{DynamicResource Git_Title}"
            Grid.Row="0"
            CloseWindowByDoubleClickOnIcon="True"
            Padding="5,0,0,0">
            <ui:TitleBar.Icon>
                <ui:SymbolIcon Symbol="Branch24" Margin="10,-3,10,0"/>
            </ui:TitleBar.Icon>
        </ui:TitleBar>

        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Margin="24">
            <StackPanel>
                <!-- Git 仓库选择 -->
                <ui:Card Margin="0,0,0,16" Visibility="{Binding HasMultipleRepositories, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <StackPanel Margin="10">
                        <TextBlock Text="{DynamicResource Git_RepoSelection}" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,8"/>
                        <TextBlock Text="{DynamicResource Git_MultipleReposDesc}" FontSize="12" Opacity="0.7" Margin="0,0,0,8"/>
                        
                        <ComboBox SelectedItem="{Binding SelectedRepository}" 
                                  ItemsSource="{Binding AvailableRepositories}"
                                  Margin="0,0,0,8">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal">
                                        <ui:SymbolIcon Symbol="Folder24" FontSize="14" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                        <StackPanel>
                                            <TextBlock Text="{Binding DisplayName}" FontWeight="Medium"/>
                                            <TextBlock Text="{Binding Path}" FontSize="11" Opacity="0.6"/>
                                        </StackPanel>
                                    </StackPanel>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                    </StackPanel>
                </ui:Card>

                <!-- Git 仓库状态 -->
                <ui:Card Margin="0,0,0,16">
                    <StackPanel Margin="10">
                        <TextBlock Text="{DynamicResource Git_RepoStatus}" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,12"/>
                        
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8" Visibility="{Binding GitInfo.IsGitRepository, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <ui:SymbolIcon Symbol="CheckmarkCircle24" Foreground="Green" Margin="0,0,8,0"/>
                            <TextBlock Text="{DynamicResource Git_IsRepo}" VerticalAlignment="Center"/>
                        </StackPanel>
                        
                        <StackPanel Margin="0,0,0,8" Visibility="{Binding GitInfo.IsGitRepository, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                                <ui:SymbolIcon Symbol="Warning24" Foreground="Orange" Margin="0,0,8,0"/>
                                <TextBlock Text="{DynamicResource Git_IsNotRepo}" VerticalAlignment="Center"/>
                            </StackPanel>
                            <ui:Button Content="{DynamicResource Git_InitRepo}" 
                                       Icon="{ui:SymbolIcon Add24}"
                                       Command="{Binding InitializeRepositoryCommand}"
                                       IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}"/>
                        </StackPanel>

                        <!-- Git 信息显示 -->
                        <Grid Margin="0,0,0,8" Visibility="{Binding GitInfo.IsGitRepository, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Grid.Column="0" Text="{DynamicResource Git_CurrentBranch}" Margin="0,0,8,4" FontWeight="Medium"/>
                            <TextBlock Grid.Row="0" Grid.Column="1" Text="{Binding GitInfo.CurrentBranch}" Margin="0,0,0,4"/>

                            <TextBlock Grid.Row="1" Grid.Column="0" Text="{DynamicResource Git_Status}" Margin="0,0,8,4" FontWeight="Medium"/>
                            <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding GitInfo.StatusDisplay}" Margin="0,0,0,4"/>

                            <TextBlock Grid.Row="2" Grid.Column="0" Text="{DynamicResource Git_UncommittedChanges}" Margin="0,0,8,4" FontWeight="Medium"/>
                            <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding GitInfo.UncommittedChanges}" Margin="0,0,0,4"/>

                            <TextBlock Grid.Row="3" Grid.Column="0" Text="{DynamicResource Git_UnpushedCommits}" Margin="0,0,8,4" FontWeight="Medium"/>
                            <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding GitInfo.UnpushedCommits}" Margin="0,0,0,4"/>

                            <TextBlock Grid.Row="4" Grid.Column="0" Text="{DynamicResource Git_LastCommit}" Margin="0,0,8,4" FontWeight="Medium"/>
                            <TextBlock Grid.Row="4" Grid.Column="1" Text="{Binding GitInfo.LastCommitMessage}" Margin="0,0,0,4" TextWrapping="Wrap"/>

                            <TextBlock Grid.Row="5" Grid.Column="0" Text="{DynamicResource Git_CommitTime}" Margin="0,0,8,4" FontWeight="Medium"/>
                            <TextBlock Grid.Row="5" Grid.Column="1" Text="{Binding GitInfo.LastCommitDateDisplay}" Margin="0,0,0,4"/>
                        </Grid>

                        <ui:Button Content="{DynamicResource Git_RefreshStatus}" 
                                   Icon="{ui:SymbolIcon ArrowSync24}"
                                   Command="{Binding RefreshGitInfoCommand}"
                                   IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}"
                                   Visibility="{Binding GitInfo.IsGitRepository, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                    </StackPanel>
                </ui:Card>

                <!-- 基本操作 -->
                <ui:Card Margin="0,0,0,16" Visibility="{Binding GitInfo.IsGitRepository, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <StackPanel Margin="10">
                        <TextBlock Text="{DynamicResource Git_BasicOps}" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,12"/>
                        
                        <!-- 提交区域 -->
                        <StackPanel Margin="0,0,0,12">
                            <TextBlock Text="{DynamicResource Git_CommitChanges}" FontWeight="Medium" Margin="0,0,0,8"/>
                            <ui:TextBox Text="{Binding CommitMessage}" 
                                     PlaceholderText="{DynamicResource Git_CommitMsgPlaceholder}" 
                                     TextWrapping="Wrap"
                                     MinHeight="60"
                                     Margin="0,0,0,8"/>
                            <WrapPanel Orientation="Horizontal">
                                <ui:Button Content="{DynamicResource Git_AddAll}" 
                                           Icon="{ui:SymbolIcon Add24}"
                                           Command="{Binding AddAllFilesCommand}"
                                           IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}"
                                           Margin="0,0,8,0"/>
                                <ui:Button Content="{DynamicResource Git_Commit}" 
                                           Icon="{ui:SymbolIcon Checkmark24}"
                                           Command="{Binding CommitCommand}"
                                           IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}"
                                           Margin="0,0,8,0"/>
                            </WrapPanel>
                        </StackPanel>

                        <!-- 同步操作 -->
                        <StackPanel>
                            <TextBlock Text="{DynamicResource Git_SyncOps}" FontWeight="Medium" Margin="0,0,0,8"/>
                            <WrapPanel Orientation="Horizontal">
                                <ui:Button Content="{DynamicResource Git_Push}" 
                                           Icon="{ui:SymbolIcon ArrowUp24}"
                                           Command="{Binding PushCommand}"
                                           IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}"
                                           Margin="0,0,8,0"/>
                                <ui:Button Content="{DynamicResource Git_Pull}" 
                                           Icon="{ui:SymbolIcon ArrowDown24}"
                                           Command="{Binding PullCommand}"
                                           IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}"
                                           Margin="0,0,8,0"/>
                            </WrapPanel>
                        </StackPanel>
                    </StackPanel>
                </ui:Card>

                <!-- 分支管理 -->
                <ui:Card Margin="0,0,0,16" Visibility="{Binding GitInfo.IsGitRepository, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <StackPanel Margin="10">
                        <TextBlock Text="{DynamicResource Git_BranchMgmt}" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,12"/>
                        
                        <!-- 当前分支 -->
                        <StackPanel Margin="0,0,0,12">
                            <TextBlock Text="{DynamicResource Git_CurrentBranchLabel}" FontWeight="Medium" Margin="0,0,0,8"/>
                            <ComboBox ItemsSource="{Binding AvailableBranches}"
                                      SelectedItem="{Binding SelectedBranch}"
                                      IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}"
                                      Margin="0,0,0,8"/>
                            <ui:Button Content="{DynamicResource Git_SwitchBranch}" 
                                       Icon="{ui:SymbolIcon Branch24}"
                                       Command="{Binding SwitchBranchCommand}"
                                       IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}"/>
                        </StackPanel>

                        <!-- 创建新分支 -->
                        <StackPanel>
                            <TextBlock Text="{DynamicResource Git_CreateNewBranch}" FontWeight="Medium" Margin="0,0,0,8"/>
                            <ui:TextBox Text="{Binding NewBranchName}" 
                                     PlaceholderText="{DynamicResource Git_NewBranchPlaceholder}"
                                     Margin="0,0,0,8"/>
                            <ui:Button Content="{DynamicResource Git_CreateBranch}" 
                                       Icon="{ui:SymbolIcon Add24}"
                                       Command="{Binding CreateBranchCommand}"
                                       IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}"/>
                        </StackPanel>
                    </StackPanel>
                </ui:Card>

                <!-- 远程仓库 -->
                <ui:Card Visibility="{Binding GitInfo.IsGitRepository, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <StackPanel Margin="10">
                        <TextBlock Text="{DynamicResource Git_RemoteRepo}" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,12"/>
                        
                        <StackPanel>
                            <TextBlock Text="{DynamicResource Git_RemoteUrl}" FontWeight="Medium" Margin="0,0,0,8"/>
                            <ui:TextBox Text="{Binding RemoteUrl}" 
                                     PlaceholderText="{DynamicResource Git_RemoteUrlPlaceholder}"
                                     Margin="0,0,0,8"/>
                            <ui:Button Content="{DynamicResource Git_SetRemote}" 
                                       Icon="{ui:SymbolIcon Globe24}"
                                       Command="{Binding SetRemoteUrlCommand}"
                                       IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}"/>
                        </StackPanel>
                    </StackPanel>
                </ui:Card>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</ui:FluentWindow>

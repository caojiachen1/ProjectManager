<Page
    x:Class="ProjectManager.Views.Pages.SystemEnvironmentVariablesPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:ProjectManager.Views.Pages"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:models="clr-namespace:ProjectManager.Models"
    Title="SystemEnvironmentVariablesPage"
    d:DataContext="{d:DesignInstance local:SystemEnvironmentVariablesPage,
                                     IsDesignTimeCreatable=False}"
    d:DesignHeight="700"
    x:Name="RootPage"
    d:DesignWidth="900"
    ui:Design.Background="{DynamicResource ApplicationBackgroundBrush}"
    ui:Design.Foreground="{DynamicResource TextFillColorPrimaryBrush}"
    Foreground="{DynamicResource TextFillColorPrimaryBrush}"
    mc:Ignorable="d">

    <Page.Resources>
        <!-- Local dark theme brushes for ListView -->
        <SolidColorBrush x:Key="ListViewBackgroundBrush" Color="#171717" />
        <SolidColorBrush x:Key="ListViewHoverBrush" Color="#2E2E2E" />
        <SolidColorBrush x:Key="ListViewSelectedBrush" Color="#3A3A3A" />
        <Style x:Key="FluentListViewItemStyle" TargetType="ListViewItem">
            <Setter Property="Padding" Value="8,6" />
            <Setter Property="Margin" Value="0" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="FocusVisualStyle" Value="{x:Null}" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{DynamicResource ListViewHoverBrush}" />
                </Trigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="{DynamicResource ListViewSelectedBrush}" />
                    <Setter Property="Foreground" Value="{DynamicResource TextOnAccentFillColorPrimaryBrush}" />
                </Trigger>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Foreground" Value="{DynamicResource TextFillColorDisabledBrush}" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="FluentGridViewColumnHeaderStyle" TargetType="GridViewColumnHeader">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorSecondaryBrush}" />
            <Setter Property="Padding" Value="8,6" />
            <Setter Property="HorizontalContentAlignment" Value="Left" />
        </Style>
        <!-- DataGrid styles modeled after FileDataGridRowStyle/FileDataGridCellStyle -->
        <Style x:Key="EnvDataGridRowStyle" TargetType="DataGridRow">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}" />
            <Style.Triggers>
                <!-- Hover matches MainWindow FileDataGridRowStyle -->
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#FF404040" />
                </Trigger>
                <!-- Selected matches MainWindow FileDataGridRowStyle -->
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="#FF606060" />
                    <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="EnvDataGridCellStyle" TargetType="DataGridCell">
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}" />
            <Setter Property="Padding" Value="8,4" />
            <Style.Triggers>
                <!-- Keep cell background transparent on selection like FileDataGridCellStyle -->
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}" />
                </Trigger>
            </Style.Triggers>
        </Style>
    </Page.Resources>

    <Grid>
        <Grid Margin="16,16,16,16">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- 搜索框 -->
            <ui:TextBox x:Name="SearchBox" Grid.Row="0" 
                        Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                        PlaceholderText="搜索环境变量..."
                        Margin="0,0,0,16">
                <ui:TextBox.Icon>
                    <ui:SymbolIcon Symbol="Search24"/>
                </ui:TextBox.Icon>
            </ui:TextBox>

            <!-- 环境变量列表 -->
            <Grid Grid.Row="1" Margin="0,0,0,16" x:Name="ContentGrid">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- 用户变量 -->
                <GroupBox Grid.Row="0" Header="用户变量" Margin="0,0,0,8" VerticalAlignment="Stretch">
                            <Grid VerticalAlignment="Stretch">
                                <ui:DataGrid ItemsSource="{Binding FilteredUserVariables}"
                                             SelectedItem="{Binding SelectedUserVariable}"
                                             MouseDoubleClick="UserVariableListView_MouseDoubleClick"
                                             AutoGenerateColumns="False"
                                             CanUserAddRows="False"
                                             CanUserDeleteRows="False"
                                             HeadersVisibility="Column"
                                             SelectionMode="Single"
                                             GridLinesVisibility="None"
                                             RowStyle="{StaticResource EnvDataGridRowStyle}"
                                             CellStyle="{StaticResource EnvDataGridCellStyle}"
                                             Background="{DynamicResource ListViewBackgroundBrush}"
                                             BorderThickness="0"
                                             Margin="0">
                                    <ui:DataGrid.Columns>
                                        <DataGridTemplateColumn Header="变量名" Width="250">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Name}" VerticalAlignment="Center" Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTemplateColumn Header="变量值" Width="*">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Value}" TextTrimming="CharacterEllipsis" ToolTip="{Binding Value}" Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                    </ui:DataGrid.Columns>
                                </ui:DataGrid>

                            <!-- 空状态 -->
                        <StackPanel HorizontalAlignment="Center" 
                                    VerticalAlignment="Center"
                                    Margin="32">
                            <StackPanel.Style>
                                <Style TargetType="StackPanel">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding HasUserVariables}" Value="False">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </StackPanel.Style>
                            <ui:SymbolIcon Symbol="People24" 
                                           FontSize="32" 
                                           Foreground="{DynamicResource TextFillColorDisabledBrush}"
                                           Margin="0,0,0,8"/>
                            <TextBlock Text="暂无用户变量" 
                                       FontSize="14" 
                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                       HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Grid>
                </GroupBox>

                <!-- 系统变量 -->
                <GroupBox Grid.Row="1" Header="系统变量" Margin="0,8,0,0" VerticalAlignment="Stretch">
                        <Grid VerticalAlignment="Stretch">
                            <ui:DataGrid ItemsSource="{Binding FilteredSystemVariables}"
                                         SelectedItem="{Binding SelectedSystemVariable}"
                                         MouseDoubleClick="SystemVariableListView_MouseDoubleClick"
                                         AutoGenerateColumns="False"
                                         CanUserAddRows="False"
                                         CanUserDeleteRows="False"
                                         HeadersVisibility="Column"
                                         SelectionMode="Single"
                                         GridLinesVisibility="None"
                                         RowStyle="{StaticResource EnvDataGridRowStyle}"
                                         CellStyle="{StaticResource EnvDataGridCellStyle}"
                                         Background="{DynamicResource ListViewBackgroundBrush}"
                                         BorderThickness="0"
                                         Margin="0">
                                <ui:DataGrid.Columns>
                                    <DataGridTemplateColumn Header="变量名" Width="250">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Name}" VerticalAlignment="Center" Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                    <DataGridTemplateColumn Header="变量值" Width="*">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Value}" TextTrimming="CharacterEllipsis" ToolTip="{Binding Value}" Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                </ui:DataGrid.Columns>
                            </ui:DataGrid>

                        <!-- 空状态 -->
                        <StackPanel HorizontalAlignment="Center" 
                                    VerticalAlignment="Center"
                                    Margin="32">
                            <StackPanel.Style>
                                <Style TargetType="StackPanel">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding HasSystemVariables}" Value="False">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </StackPanel.Style>
                            <ui:SymbolIcon Symbol="Shield24" 
                                           FontSize="32" 
                                           Foreground="{DynamicResource TextFillColorDisabledBrush}"
                                           Margin="0,0,0,8"/>
                            <TextBlock Text="暂无系统变量" 
                                       FontSize="14" 
                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                       HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Grid>
                </GroupBox>
            </Grid>

            <!-- 底部按钮 -->
            <StackPanel x:Name="FooterPanel" Grid.Row="2" 
                        Orientation="Horizontal" 
                        HorizontalAlignment="Right">
                <ui:Button Content="刷新" 
                           Command="{Binding RefreshCommand}"
                           Appearance="Secondary"
                           Margin="0,0,8,0"
                           Padding="20,8">
                    <ui:Button.Icon>
                        <ui:SymbolIcon Symbol="ArrowClockwise24"/>
                    </ui:Button.Icon>
                </ui:Button>
                <ui:Button Content="编辑用户变量" 
                           Command="{Binding EditUserVariableCommand}"
                           Appearance="Primary"
                           IsEnabled="{Binding HasSelectedUserVariable}"
                           Margin="0,0,8,0"
                           Padding="20,8">
                    <ui:Button.Icon>
                        <ui:SymbolIcon Symbol="Edit24"/>
                    </ui:Button.Icon>
                </ui:Button>
                <ui:Button Content="编辑系统变量" 
                           Command="{Binding EditSystemVariableCommand}"
                           Appearance="Primary"
                           IsEnabled="{Binding HasSelectedSystemVariable}"
                           Padding="20,8">
                    <ui:Button.Icon>
                        <ui:SymbolIcon Symbol="Shield24"/>
                    </ui:Button.Icon>
                </ui:Button>
            </StackPanel>
        </Grid>
    </Grid>
</Page>
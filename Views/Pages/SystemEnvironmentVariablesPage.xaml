<Page
    x:Class="ProjectManager.Views.Pages.SystemEnvironmentVariablesPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:ProjectManager.Views.Pages"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:models="clr-namespace:ProjectManager.Models"
    xmlns:controls="clr-namespace:ProjectManager.Controls"
    Title="SystemEnvironmentVariablesPage"
    d:DataContext="{d:DesignInstance local:SystemEnvironmentVariablesPage,
                                     IsDesignTimeCreatable=False}"
    d:DesignHeight="700"
    x:Name="RootPage"
    d:DesignWidth="900"
    ui:Design.Background="{DynamicResource ApplicationBackgroundBrush}"
    ui:Design.Foreground="{DynamicResource TextFillColorPrimaryBrush}"
    Foreground="{DynamicResource TextFillColorPrimaryBrush}"
    mc:Ignorable="d"
    Loaded="SystemEnvironmentVariablesPage_Loaded"
    Unloaded="SystemEnvironmentVariablesPage_Unloaded">

    <Page.Resources>
        <!-- Local dark theme brushes for ListView -->
        <SolidColorBrush x:Key="ListViewBackgroundBrush" Color="#171717" />
        <SolidColorBrush x:Key="ListViewHoverBrush" Color="#2E2E2E" />
        <SolidColorBrush x:Key="ListViewSelectedBrush" Color="#3A3A3A" />
        <Style x:Key="FluentListViewItemStyle" TargetType="ListViewItem">
            <Setter Property="Padding" Value="8,6" />
            <Setter Property="Margin" Value="0" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="BorderBrush" Value="Transparent" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="FocusVisualStyle" Value="{x:Null}" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{DynamicResource ListViewHoverBrush}" />
                </Trigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="{DynamicResource ListViewSelectedBrush}" />
                    <Setter Property="Foreground" Value="{DynamicResource TextOnAccentFillColorPrimaryBrush}" />
                </Trigger>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Foreground" Value="{DynamicResource TextFillColorDisabledBrush}" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="FluentGridViewColumnHeaderStyle" TargetType="GridViewColumnHeader">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorSecondaryBrush}" />
            <Setter Property="Padding" Value="8,6" />
            <Setter Property="HorizontalContentAlignment" Value="Left" />
        </Style>
        
        <!-- Custom DataGridColumnHeader style with single gripper -->
        <Style x:Key="SingleGripperColumnHeaderStyle" TargetType="DataGridColumnHeader">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorSecondaryBrush}"/>
            <Setter Property="Padding" Value="8,6"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="DataGridColumnHeader">
                        <Grid>
                            <Border x:Name="columnHeaderBorder" 
                                    BorderThickness="0" 
                                    Padding="{TemplateBinding Padding}"
                                    Background="{TemplateBinding Background}">
                                <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                                SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"/>
                            </Border>
                            <!-- Only right gripper for single resize point -->
                            <Thumb x:Name="PART_RightHeaderGripper" 
                                   HorizontalAlignment="Right"
                                   Width="4"
                                   Background="Transparent"
                                   Cursor="SizeWE">
                                <Thumb.Template>
                                    <ControlTemplate TargetType="Thumb">
                                        <Border Background="{TemplateBinding Background}" 
                                                Width="{TemplateBinding Width}">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Background" Value="Transparent"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsMouseOver, RelativeSource={RelativeSource AncestorType=DataGridColumnHeader}}" Value="True">
                                                            <Setter Property="Background" Value="{DynamicResource TextFillColorSecondaryBrush}"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                        </Border>
                                    </ControlTemplate>
                                </Thumb.Template>
                            </Thumb>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <!-- DataGrid styles modeled after FileDataGridRowStyle/FileDataGridCellStyle -->
        <Style x:Key="EnvDataGridRowStyle" TargetType="DataGridRow">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}" />
            <Style.Triggers>
                <!-- Hover matches MainWindow FileDataGridRowStyle -->
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#FF404040" />
                </Trigger>
                <!-- Selected matches MainWindow FileDataGridRowStyle -->
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="#FF606060" />
                    <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="EnvDataGridCellStyle" TargetType="DataGridCell">
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}" />
            <Setter Property="Padding" Value="8,4" />
            <Style.Triggers>
                <!-- Keep cell background transparent on selection like FileDataGridCellStyle -->
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="Transparent" />
                    <Setter Property="Foreground" Value="{DynamicResource TextFillColorPrimaryBrush}" />
                </Trigger>
            </Style.Triggers>
        </Style>
    </Page.Resources>

    <Grid>
        <!-- 环境变量列表 -->
        <Grid Margin="16,16,16,16" x:Name="ContentGrid">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- 用户变量 -->
            <GroupBox Grid.Row="0" Header="用户变量" Margin="0,0,0,8" VerticalAlignment="Stretch">
                            <Grid VerticalAlignment="Stretch">
                                <ui:DataGrid ItemsSource="{Binding FilteredUserVariables}"
                                             SelectedItem="{Binding SelectedUserVariable}"
                                             MouseDoubleClick="UserVariableListView_MouseDoubleClick"
                                             KeyDown="UserVariableDataGrid_KeyDown"
                                             AutoGenerateColumns="False"
                                             Margin="0,0,0,8"
                                             ColumnHeaderStyle="{StaticResource SingleGripperColumnHeaderStyle}"
                                             CanUserAddRows="False"
                                             CanUserDeleteRows="False"
                                             IsReadOnly="True"
                                             RowHeaderWidth="0"
                                             RowStyle="{StaticResource EnvDataGridRowStyle}"
                                             CellStyle="{StaticResource EnvDataGridCellStyle}"
                                             SelectionMode="Single">
                                    <ui:DataGrid.Columns>
                                        <!-- 类型图标列 - 固定宽度，只显示图标 -->
                                    <DataGridTemplateColumn Header="" Width="32" MinWidth="32" DisplayIndex="0">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <ui:SymbolIcon Symbol="People24" 
                                                               Foreground="{DynamicResource SystemFillColorSuccessBrush}"
                                                               VerticalAlignment="Center"
                                                               HorizontalAlignment="Center"
                                                               ToolTip="用户变量"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                    
                                    <DataGridTemplateColumn Header="变量名" Width="250" MinWidth="200" DisplayIndex="1">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Name}" 
                                                               VerticalAlignment="Center" 
                                                               Margin="8,4"
                                                               Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                        <DataGridTemplateColumn Header="变量值" Width="*">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Value}" 
                                                               TextTrimming="CharacterEllipsis" 
                                                               ToolTip="{Binding Value}" 
                                                               VerticalAlignment="Center"
                                                               Margin="8,4"
                                                               Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                    </ui:DataGrid.Columns>
                                </ui:DataGrid>

                            <!-- 空状态 -->
                        <StackPanel HorizontalAlignment="Center" 
                                    VerticalAlignment="Center"
                                    Margin="32">
                            <StackPanel.Style>
                                <Style TargetType="StackPanel">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding HasUserVariables}" Value="False">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </StackPanel.Style>
                            <ui:SymbolIcon Symbol="People24" 
                                           FontSize="32" 
                                           Foreground="{DynamicResource TextFillColorDisabledBrush}"
                                           Margin="0,0,0,8"/>
                            <TextBlock Text="暂无用户变量" 
                                       FontSize="14" 
                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                       HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Grid>
                </GroupBox>

                <!-- 系统变量 -->
                <GroupBox Grid.Row="1" Header="系统变量" Margin="0,8,0,0" VerticalAlignment="Stretch">
                        <Grid VerticalAlignment="Stretch">
                            <ui:DataGrid ItemsSource="{Binding FilteredSystemVariables}"
                                         SelectedItem="{Binding SelectedSystemVariable}"
                                         MouseDoubleClick="SystemVariableListView_MouseDoubleClick"
                                         KeyDown="SystemVariableDataGrid_KeyDown"
                                         AutoGenerateColumns="False"
                                         Margin="0,0,0,8"
                                         ColumnHeaderStyle="{StaticResource SingleGripperColumnHeaderStyle}"
                                         CanUserAddRows="False"
                                         CanUserDeleteRows="False"
                                         IsReadOnly="True"
                                         RowHeaderWidth="0"
                                         RowStyle="{StaticResource EnvDataGridRowStyle}"
                                         CellStyle="{StaticResource EnvDataGridCellStyle}"
                                         SelectionMode="Single">
                                <ui:DataGrid.Columns>
                                    <!-- 类型图标列 - 固定宽度，只显示图标 -->
                                <DataGridTemplateColumn Header="" Width="32" MinWidth="32" DisplayIndex="0">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <ui:SymbolIcon Symbol="Shield24" 
                                                           Foreground="{DynamicResource SystemFillColorCautionBrush}"
                                                           VerticalAlignment="Center"
                                                           HorizontalAlignment="Center"
                                                           ToolTip="系统变量"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                
                                <DataGridTemplateColumn Header="变量名" Width="250" MinWidth="200" DisplayIndex="1">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Name}" 
                                                           VerticalAlignment="Center" 
                                                           Margin="8,4"
                                                           Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                    <DataGridTemplateColumn Header="变量值" Width="*">
                                        <DataGridTemplateColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Value}" 
                                                           TextTrimming="CharacterEllipsis" 
                                                           ToolTip="{Binding Value}" 
                                                           VerticalAlignment="Center"
                                                           Margin="8,4"
                                                           Foreground="{DynamicResource TextFillColorPrimaryBrush}"/>
                                            </DataTemplate>
                                        </DataGridTemplateColumn.CellTemplate>
                                    </DataGridTemplateColumn>
                                </ui:DataGrid.Columns>
                            </ui:DataGrid>

                        <!-- 空状态 -->
                        <StackPanel HorizontalAlignment="Center" 
                                    VerticalAlignment="Center"
                                    Margin="32">
                            <StackPanel.Style>
                                <Style TargetType="StackPanel">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding HasSystemVariables}" Value="False">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </StackPanel.Style>
                            <ui:SymbolIcon Symbol="Shield24" 
                                           FontSize="32" 
                                           Foreground="{DynamicResource TextFillColorDisabledBrush}"
                                           Margin="0,0,0,8"/>
                            <TextBlock Text="暂无系统变量" 
                                       FontSize="14" 
                                       Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                       HorizontalAlignment="Center"/>
                        </StackPanel>
                    </Grid>
                </GroupBox>
        </Grid>
    </Grid>
</Page>